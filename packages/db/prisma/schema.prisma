generator client {
   provider = "prisma-client"
   output   = "../generated/prisma"
}

datasource db {
   provider = "postgresql"
}

enum Role {
   user
   admin
}

enum Language {
   javascript
   typescript
   python
   java
   go
   csharp
   php
}

enum Status {
   pending
   running
   failed
   accepted
}

model User {
   clerk_id       String   @id @unique
   email          String   @unique
   email_verified Boolean?
   first_name     String
   last_name      String
   phone          String?
   profile_pic    String?
   bio            String?
   resume_obj_key String?
   gh_url         String?
   lc_url         String?
   cf_url         String?
   created_at     DateTime @default(now())
   updated_at     DateTime @updatedAt

   role Role

   leaderboards Leaderboard[]
   submissions  Submission[]

   @@index([clerk_id])
}

model Contest {
   id         String   @id @default(uuid())
   title      String   @unique
   deadline   DateTime
   start_time DateTime

   leaderboards                 Leaderboard[]
   contest_to_challenge_mapping Contest_to_Challenge_mapping[]
}

model Contest_to_Challenge_mapping {
   id           String       @id @default(uuid())
   position     Int
   contest_id   String
   challenge_id String
   submissions  Submission[]

   contest   Contest   @relation(fields: [contest_id], references: [id], onDelete: Cascade)
   challenge Challenge @relation(fields: [challenge_id], references: [id], onDelete: Cascade)

   @@unique([contest_id, challenge_id])
   @@unique([contest_id, position])
}

model Challenge {
   id            String @id @default(uuid())
   title         String @unique
   max_pts       Int
   challenge_doc String

   contest_to_challenge_mapping Contest_to_Challenge_mapping[]
}

model Submission {
   id         String   @id @default(uuid())
   points     Int
   submission String
   language   Language
   status     Status
   feedback   String?
   user_id    String
   created_at DateTime @default(now())

   user                            User                         @relation(fields: [user_id], references: [clerk_id])
   contest_to_challenge_mapping_id String
   contest_to_challenge_mapping    Contest_to_Challenge_mapping @relation(fields: [contest_to_challenge_mapping_id], references: [id], onDelete: Cascade)

   @@index([user_id])
   @@index([contest_to_challenge_mapping_id])
}

model Leaderboard {
   id         String @id @default(uuid())
   rank       Int
   contest_id String
   user_id    String

   contest Contest @relation(fields: [contest_id], references: [id], onDelete: Cascade)
   user    User    @relation(fields: [user_id], references: [clerk_id])

   @@unique([contest_id, user_id])
   @@unique([contest_id, rank])
}
